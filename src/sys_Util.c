////////////////////////////////////////////////////////////////////////////////
//
// LRU (Generic)
//
// Desc: sys_Util.c
// Utility.
//
// 12/09/2022 (Jos√© Benavente)
// File inception.
//
////////////////////////////////////////////////////////////////////////////////

#include "main.h"
#include "sys_Util.h"

////////////////////////////////////////////////////////////////////////////////
// Macros:
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Types:
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Prototypes:
////////////////////////////////////////////////////////////////////////////////

bool CheckUtf8(char *str, int size, bool truncate);
bool AsciiToUtf8(char *str, int size);

////////////////////////////////////////////////////////////////////////////////
// Globals:
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Procedures:
////////////////////////////////////////////////////////////////////////////////

//
// ascii to utf-8 conversions
//

bool CheckUtf8(char *str, int size, bool truncate) {
  size_t len = strnlen(str, size);
  char *p = (char *) u8_check((uint8_t *)str, len);

  if (p && truncate) {
    *p = '\0';
  }

  return !p;
}

bool AsciiToUtf8(char *str, int size) {
  if (CheckUtf8(str, size, false)) {
    return true;
  }

  uint8_t *ustr = u8_strconv_from_encoding(str, "WINDOWS-1252", iconveh_question_mark);

  if (ustr) {
    strncpy(str, (char *)ustr, size-1);
    str[size-1] = '\0';
    free(ustr);

    return true;
  }

  return false;
}
